{% extends "base.html" %}

{% block content %}
<div class="container mt-4" style="font-family: 'Calibri', sans-serif; max-width: 950px;">
    <form action="{{ url_for('contract_invoice', id=invoice.id if invoice else None) }}" method="POST" id="contractInvoiceForm">
        <input type="hidden" name="linked_slab_name" id="linked_slab_name" value="{{ invoice.slab_name if invoice else '' }}">
        <input type="hidden" name="total_amount" id="final_total_hidden">

        <div class="card shadow-sm mb-4 border-0">
            <div class="card-header bg-white py-3 border-bottom">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h4 class="mb-0 text-primary">{{ 'Edit' if invoice else 'Create' }} Contract Invoice</h4>
                    </div>
                    
                </div>
            </div>

            <div class="card-body">
                <div class="row g-3 mb-4 p-3 rounded border border-primary bg-light shadow-sm">
                    <div class="col-md-12">
                        <label class="form-label fw-bold text-primary"><i class="fa-solid fa-file-contract me-2"></i>1. Select Contract First</label>
                        <select name="contract_id" id="contract_select" class="form-select border-primary fw-bold" required>
                            <option value="">-- Start by selecting a contract --</option>
                            {% for c in contracts %}
                            <option value="{{ c.id }}" 
                                    data-customer-id="{{ c.customer_id }}" 
                                    data-service-id="{{ c.primary_service_id }}"
                                    data-slabs='{{ c.slabs_list_json | safe }}' 
                                    {% if invoice and invoice.contract_id == c.id %}selected{% endif %}>
                                {{ c.contract_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <label class="form-label small fw-bold text-uppercase text-muted">Customer (Auto-filled)</label>
                        <select name="customer_id" id="customer_select" class="form-select form-select-sm bg-light" required>
                            <option value="">Select Customer</option>
                            {% for c in customers %}
                            <option value="{{ c.id }}" 
                                    data-cname="{{ c.company_name }}"
                                    data-address="{{ c.address }}"
                                    data-gst-number="{{ c.gst_number }}"
                                    data-gst-type="{{ c.gst_type }}"
                                    {% if invoice and invoice.customer_id == c.id %}selected{% endif %}>
                                {{ c.company_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold text-uppercase text-muted">Invoice Number</label>
                        <input type="text" name="invoice_number" class="form-control form-control-sm bg-light" value="{{ invoice.invoice_number if invoice else suggested_no }}" readonly>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold text-uppercase text-muted">Invoice Date</label>
                        <input type="date" name="invoice_date" class="form-control form-control-sm" value="{{ invoice.invoice_date.strftime('%Y-%m-%d') if invoice else now.strftime('%Y-%m-%d') }}" required>
                    </div>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-8">
                        <label class="form-label small fw-bold">Select Milestone (Slab)</label>
                        <select name="slab_select_input" id="slab_select" class="form-select form-select-sm border-primary">
                            <option value="">-- Choose Milestone --</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small fw-bold">Tax Type</label>
                        <select name="tax_type" id="tax_type" class="form-select form-select-sm" onchange="calculateTotal()">
                            <option value="GST">CGST+SGST (18%)</option>
                            <option value="IGST">IGST (18%)</option>
                            <option value="NONE">No Tax (0%)</option>
                        </select>
                    </div>
                </div>

                
                <div id="service_rows">
                    <div class="row g-2 mb-2 align-items-end service-row">
                        <div class="col-md-7">
                            <label class="extra-small text-muted">Service Description</label>
                            <select name="service_ids[]" id="main_service_id" class="form-select form-select-sm">
                                <option value="">Select Service</option>
                                {% for s in services %}
                                <option value="{{ s.id }}" data-sname="{{ s.service_name }}">{{ s.service_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-5">
                            <label class="extra-small text-muted">Base Amount</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">₹</span>
                                <input type="number" step="0.01" name="amounts[]" class="form-control line-amount fw-bold" placeholder="0.00">
                            </div>
                        </div>
                    </div>
                </div>

                <hr class="my-4">

                <div class="row align-items-center bg-light rounded p-3 text-center border">
                    <div class="col-md-4">
                        <span class="small fw-bold d-block text-muted text-uppercase">Subtotal</span>
                        <h5 class="fw-bold mb-0">₹ <span id="display_subtotal">0.00</span></h5>
                    </div>
                    <div class="col-md-4 border-start">
                        <span class="small fw-bold d-block text-muted text-uppercase" id="tax_label_ui">Tax (18%)</span>
                        <h5 class="fw-bold mb-0">₹ <span id="display_tax">0.00</span></h5>
                    </div>
                    <div class="col-md-4 border-start">
                        <span class="small fw-bold d-block text-primary text-uppercase">Grand Total</span>
                        <h4 class="text-primary fw-bold mb-0">₹ <span id="display_total">0.00</span></h4>
                    </div>
                </div>
            </div>
            
            
            <div class="card-footer bg-white py-3 d-flex justify-content-between align-items-center">
            <div>
                <a href="{{ url_for('edit_list') }}" class="btn btn-outline-secondary btn-sm">
                    <i class="fa-solid fa-arrow-left me-1"></i> Back to Registry
                </a>
            </div>

            <div>
                <button type="button" class="btn btn-outline-info me-2" onclick="updatePrintPreview()" data-bs-toggle="modal" data-bs-target="#previewModal">
                    <i class="fa-solid fa-eye me-1"></i> Print Preview
                </button>
                <button type="submit" class="btn btn-primary px-5 fw-bold">
                    <i class="fa-solid fa-save me-1"></i> Save Invoice
                </button>
            </div>
        </div>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const contractSelect = document.getElementById('contract_select');
    const customerSelect = document.getElementById('customer_select');
    const slabSelect = document.getElementById('slab_select');
    const taxTypeSelect = document.getElementById('tax_type');
    const serviceRows = document.getElementById('service_rows');
    
    // This value comes from your database/hidden input
    const savedSlabName = document.getElementById('linked_slab_name').value;

    contractSelect.addEventListener('change', function() {
        const opt = this.options[this.selectedIndex];
        slabSelect.innerHTML = '<option value="">-- Choose Milestone --</option>';
        
        if (opt.value) {
            // 1. Map Customer
            customerSelect.value = opt.dataset.customerId;
            
            // 2. Map Tax Type
            const custOpt = customerSelect.options[customerSelect.selectedIndex];
            if (custOpt) {
                const gstType = custOpt.dataset.gstType;
                taxTypeSelect.value = (gstType === "IGST") ? "IGST" : 
                                     (gstType === "NONE" ? "NONE" : "GST");
            }

            // 3. Map Primary Service
            const serviceId = opt.dataset.serviceId;
            if (serviceId) document.getElementById('main_service_id').value = serviceId;

            // 4. Load Slabs and Auto-calculate if Edit mode
            const slabs = JSON.parse(opt.dataset.slabs || '[]');
            let matchedAmount = null;

            slabs.forEach(s => {
                let o = document.createElement('option');
                o.value = s.name;
                o.text = `${s.name} (₹${parseFloat(s.amount).toLocaleString()})`;
                o.setAttribute('data-amount', s.amount);
                
                // If this is the saved milestone from the database
                if (s.name === savedSlabName) {
                    o.selected = true;
                    matchedAmount = s.amount; // Store the amount to apply it below
                }
                slabSelect.add(o);
            });

            // 5. If we matched a milestone (Edit mode), push the amount to the input
            if (matchedAmount !== null) {
                const firstAmtInput = serviceRows.querySelector('.line-amount');
                if (firstAmtInput && (!firstAmtInput.value || firstAmtInput.value == "0" || firstAmtInput.value == "0.00")) {
                    firstAmtInput.value = parseFloat(matchedAmount).toFixed(2);
                }
            }
            
            calculateTotal();
        }
    });

    // Manual selection of milestone
    slabSelect.addEventListener('change', function() {
        const opt = this.options[this.selectedIndex];
        const amount = opt.getAttribute('data-amount');
        document.getElementById('linked_slab_name').value = opt.value;
        
        if (amount) {
            const firstAmtInput = serviceRows.querySelector('.line-amount');
            if (firstAmtInput) {
                firstAmtInput.value = parseFloat(amount).toFixed(2);
                calculateTotal();
            }
        }
    });

    window.calculateTotal = function() {
        let subtotal = 0;
        document.querySelectorAll('.line-amount').forEach(input => {
            subtotal += parseFloat(input.value || 0);
        });

        const taxType = taxTypeSelect.value;
        let taxPercent = (taxType === 'NONE') ? 0 : 0.18;
        let taxAmount = subtotal * taxPercent;
        let grandTotal = subtotal + taxAmount;

        document.getElementById('display_subtotal').innerText = subtotal.toLocaleString('en-IN', { minimumFractionDigits: 2 });
        document.getElementById('display_tax').innerText = taxAmount.toLocaleString('en-IN', { minimumFractionDigits: 2 });
        document.getElementById('display_total').innerText = grandTotal.toLocaleString('en-IN', { minimumFractionDigits: 2 });
        
        document.getElementById('final_total_hidden').value = grandTotal.toFixed(2);
        
        const taxLabel = document.getElementById('tax_label_ui');
        taxLabel.innerText = (taxType === "GST") ? "Tax (CGST+SGST 18%)" : 
                             (taxType === "IGST" ? "Tax (IGST 18%)" : "Tax (0%)");
    };

    serviceRows.addEventListener('input', (e) => { if(e.target.classList.contains('line-amount')) calculateTotal(); });
    
    // Trigger the flow on load
    if(contractSelect.value) {
        contractSelect.dispatchEvent(new Event('change'));
    }
});

// SYNCED PRINT PREVIEW
function updatePrintPreview() {
    const custOpt = document.getElementById('customer_select').selectedOptions[0];
    const serviceOpt = document.getElementById('main_service_id').selectedOptions[0];
    
    // 1. Get the raw base amount from the form
    const rawAmountStr = document.getElementById('display_subtotal').innerText.replace(/,/g, '');
    const baseAmount = parseFloat(rawAmountStr) || 0;
    const taxType = document.getElementById('tax_type').value;

    // 2. Header Information
    document.getElementById('p_invoice_no').innerText = document.querySelector('input[name="invoice_number"]').value || "---";
    document.getElementById('p_invoice_date').innerText = document.querySelector('input[name="invoice_date"]').value || "---";
    document.getElementById('p_customer_name').innerText = custOpt ? custOpt.dataset.cname : "---";
    document.getElementById('p_customer_address').innerText = (custOpt ? custOpt.dataset.address : "") || "---";
    document.getElementById('p_customer_gst').innerText = (custOpt ? custOpt.dataset.gstNumber : "") || "N/A";

    // 3. Description Column
    let descHTML = `<b style="font-size: 11pt;">${serviceOpt ? serviceOpt.dataset.sname : 'Service'}</b><br>`;
    descHTML += `<span>Milestone: ${document.getElementById('slab_select').value || 'Contract Milestone'}</span><br><br>`;
    
    // 4. Tax Logic & Amount Column
    // We calculate tax but we will ADD it to the subtotal display as per your request
    let totalTaxAmt = 0;
    let taxLinesHTML = "";

    if (taxType === 'GST') {
        let cgst = baseAmount * 0.09;
        let sgst = baseAmount * 0.09;
        totalTaxAmt = cgst + sgst;
        taxLinesHTML = `${cgst.toFixed(2)}<br>${sgst.toFixed(2)}<br>0.00`;
    } else if (taxType === 'IGST') {
        totalTaxAmt = baseAmount * 0.18;
        taxLinesHTML = `0.00<br>0.00<br>${totalTaxAmt.toFixed(2)}`;
    } else {
        totalTaxAmt = 0;
        taxLinesHTML = `0.00<br>0.00<br>0.00`;
    }

    // THE KEY CHANGE: Both Subtotal and Total include the GST
    const inclusiveTotal = (baseAmount + totalTaxAmt).toFixed(2);

    // 5. Construct Table Rows
    let amtHTML = `${baseAmount.toFixed(2)}<br><br><br>`; // Raw service amount
    amtHTML += taxLinesHTML; // Tax breakdown lines

    // Add Tax Headings to Description
    descHTML += `Central GST [CGST] - 9%<br>`;
    descHTML += `State GST [SGST] - 9%<br>`;
    descHTML += `Integrated GST [IGST] - 18%`;

    // 6. Push to Modal UI
    document.getElementById('p_description').innerHTML = descHTML;
    document.getElementById('p_amount_col').innerHTML = amtHTML;

    // Update Footer: Both Subtotal and Total now show the same GST-inclusive value
    if(document.getElementById('p_subtotal_final')) {
        document.getElementById('p_subtotal_final').innerText = inclusiveTotal;
    }
    if(document.getElementById('p_total_final')) {
        document.getElementById('p_total_final').innerText = inclusiveTotal;
    }
}
</script>

{% include 'invoice_bill.html' %}
{% endblock %}