{% extends "base.html" %}
{% block content %}
<div class="container" style="max-width: 900px;">
    
    <form method="POST" enctype="multipart/form-data" action="{{ url_for('edit_customer', id=customer.id) if customer else url_for('create_customer') }}">
        
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0">{{ 'Edit' if customer else 'Create' }} Customer Details</h4>
                <a href="{{ url_for('list_customers') }}" class="btn btn-light btn-sm border">Back to List</a>
            </div>
            <div class="card-body">
                <div class="row g-3 mb-3">
                    <div class="col-md-12">
                        <label class="form-label">Company Name <span class="text-danger">*</span></label>
                        <input type="text" name="company_name" class="form-control" required 
                               value="{{ customer.company_name if customer else '' }}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Contact First Name</label>
                        <input type="text" name="first_name" class="form-control"
                               value="{{ customer.first_name if customer else '' }}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Contact Last Name</label>
                        <input type="text" name="last_name" class="form-control"
                               value="{{ customer.last_name if customer else '' }}">
                    </div>
                </div>

                <div class="row g-3 mb-3">
                    <div class="col-12">
                        <label class="form-label">Street Address</label>
                        <textarea name="address" class="form-control" rows="2">{{ customer.address if customer else '' }}</textarea>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">City</label>
                        <input type="text" name="city" class="form-control" value="{{ customer.city if customer else '' }}">
                    </div>
                    
                    <div class="col-md-4">
                        <label class="form-label">State <span class="text-danger">*</span></label>
                        <select name="state" id="state" class="form-select" onchange="handleLocationChange()" required>
                            <option value="" disabled {% if not customer or not customer.state %}selected{% endif %}>Select State</option>
                            {% set states = [
                                'Andhra Pradesh', 'Arunachal Pradesh', 'Assam', 'Bihar', 'Chhattisgarh', 'Goa', 'Gujarat', 
                                'Haryana', 'Himachal Pradesh', 'Jharkhand', 'Karnataka', 'Kerala', 'Madhya Pradesh', 
                                'Maharashtra', 'Manipur', 'Meghalaya', 'Mizoram', 'Nagaland', 'Odisha', 'Punjab', 
                                'Rajasthan', 'Sikkim', 'Tamil Nadu', 'Telangana', 'Tripura', 'Uttar Pradesh', 
                                'Uttarakhand', 'West Bengal', 'Andaman and Nicobar Islands', 'Chandigarh', 
                                'Dadra and Nagar Haveli', 'Daman and Diu', 'Delhi', 'Lakshadweep', 'Puducherry', 
                                'Jammu and Kashmir', 'Ladakh', 'Outside India'
                            ] %}
                            {% for s in states %}
                            <option value="{{ s }}" {% if customer and customer.state == s %}selected{% endif %}>{{ s }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-4">
                        <label class="form-label">Country <span class="text-danger">*</span></label>
                        <select name="country" id="country" class="form-select" onchange="updateCountryLogic()" required>
                            <option value="" disabled {% if not customer or not customer.country %}selected{% endif %}>Select Country</option>
                            <option value="India" {% if customer and customer.country == 'India' %}selected{% endif %}>India</option>
                            
                            {% set countries = [
                                'Afghanistan', 'Albania', 'Algeria', 'Argentina', 'Australia', 'Austria', 'Bahrain', 'Bangladesh', 'Belgium', 'Brazil', 
                                'Canada', 'China', 'Denmark', 'Egypt', 'Finland', 'France', 'Germany', 'Greece', 'Hong Kong', 'Indonesia', 'Iran', 'Iraq', 
                                'Ireland', 'Israel', 'Italy', 'Japan', 'Kuwait', 'Malaysia', 'Mexico', 'Nepal', 'Netherlands', 'New Zealand', 'Norway', 
                                'Oman', 'Pakistan', 'Philippines', 'Poland', 'Portugal', 'Qatar', 'Russia', 'Saudi Arabia', 'Singapore', 'South Africa', 
                                'South Korea', 'Spain', 'Sri Lanka', 'Sweden', 'Switzerland', 'Thailand', 'Turkey', 'UAE', 'UK', 'USA', 'Vietnam'
                            ] %}
                            
                            {% for c in countries %}
                            <option value="{{ c }}" {% if customer and customer.country == c %}selected{% endif %}>{{ c }}</option>
                            {% endfor %}
                            <option value="Other" {% if customer and customer.country == 'Other' %}selected{% endif %}>Other</option>
                        </select>
                    </div>
                </div>

                <div class="row g-3 mb-3 p-3 bg-light rounded border">
                    <div class="col-md-3">
                        <label class="form-label">GST Status</label>
                        <select name="gst_status" id="gst_status" class="form-select" onchange="toggleGSTFields()">
                            <option value="Registered" {% if not customer or customer.gst_status == 'Registered' %}selected{% endif %}>Yes (Registered)</option>
                            <option value="No_Forex" {% if customer and customer.gst_status == 'No_Forex' %}selected{% endif %}>No (Export/Forex)</option>
                            <option value="No_SEZ" {% if customer and customer.gst_status == 'No_SEZ' %}selected{% endif %}>No (SEZ)</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">GST Number</label>
                        <input type="text" name="gst_number" id="gst_number" class="form-control" value="{{ customer.gst_number if customer else '' }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Tax Type</label>
                        <select name="gst_type" id="gst_type" class="form-select">
                            <option value="">-- N/A --</option>
                            <option value="CGST_SGST" {% if customer and customer.gst_type == 'CGST_SGST' %}selected{% endif %}>CGST + SGST</option>
                            <option value="IGST" {% if customer and customer.gst_type == 'IGST' %}selected{% endif %}>IGST</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Currency</label>
                        <select name="currency" id="currency" class="form-select" required>
                            <option value="" disabled {% if not customer or not customer.currency %}selected{% endif %}>Select</option>
                            <option value="INR" {% if customer and customer.currency == 'INR' %}selected{% endif %}>INR (₹)</option>
                            <option value="USD" {% if customer and customer.currency == 'USD' %}selected{% endif %}>USD ($)</option>
                            <option value="EUR" {% if customer and customer.currency == 'EUR' %}selected{% endif %}>EUR (€)</option>
                            <option value="GBP" {% if customer and customer.currency == 'GBP' %}selected{% endif %}>GBP (£)</option>
                            <option value="AED" {% if customer and customer.currency == 'AED' %}selected{% endif %}>AED (د.إ)</option>
                            <option value="SGD" {% if customer and customer.currency == 'SGD' %}selected{% endif %}>SGD (S$)</option>
                            <option value="AUD" {% if customer and customer.currency == 'AUD' %}selected{% endif %}>AUD (A$)</option>
                            <option value="CAD" {% if customer and customer.currency == 'CAD' %}selected{% endif %}>CAD (C$)</option>
                            <option value="JPY" {% if customer and customer.currency == 'JPY' %}selected{% endif %}>JPY (¥)</option>
                            <option value="CNY" {% if customer and customer.currency == 'CNY' %}selected{% endif %}>CNY (¥)</option>
                            <option value="CHF" {% if customer and customer.currency == 'CHF' %}selected{% endif %}>CHF (Fr)</option>
                            <option value="SEK" {% if customer and customer.currency == 'SEK' %}selected{% endif %}>SEK (kr)</option>
                            <option value="RUB" {% if customer and customer.currency == 'RUB' %}selected{% endif %}>RUB (₽)</option>
                            <option value="ZAR" {% if customer and customer.currency == 'ZAR' %}selected{% endif %}>ZAR (R)</option>
                            <option value="BRL" {% if customer and customer.currency == 'BRL' %}selected{% endif %}>BRL (R$)</option>
                            <option value="MXN" {% if customer and customer.currency == 'MXN' %}selected{% endif %}>MXN ($)</option>
                            <option value="SAR" {% if customer and customer.currency == 'SAR' %}selected{% endif %}>SAR (﷼)</option>
                            <option value="QAR" {% if customer and customer.currency == 'QAR' %}selected{% endif %}>QAR (﷼)</option>
                            <option value="KWD" {% if customer and customer.currency == 'KWD' %}selected{% endif %}>KWD (د.ك)</option>
                            <option value="BHD" {% if customer and customer.currency == 'BHD' %}selected{% endif %}>BHD (.د.ب)</option>
                            <option value="OMR" {% if customer and customer.currency == 'OMR' %}selected{% endif %}>OMR (﷼)</option>
                            <option value="THB" {% if customer and customer.currency == 'THB' %}selected{% endif %}>THB (฿)</option>
                            <option value="MYR" {% if customer and customer.currency == 'MYR' %}selected{% endif %}>MYR (RM)</option>
                            <option value="IDR" {% if customer and customer.currency == 'IDR' %}selected{% endif %}>IDR (Rp)</option>
                            <option value="VND" {% if customer and customer.currency == 'VND' %}selected{% endif %}>VND (₫)</option>
                            <option value="PHP" {% if customer and customer.currency == 'PHP' %}selected{% endif %}>PHP (₱)</option>
                            <option value="HKD" {% if customer and customer.currency == 'HKD' %}selected{% endif %}>HKD (HK$)</option>
                            <option value="KRW" {% if customer and customer.currency == 'KRW' %}selected{% endif %}>KRW (₩)</option>
                            <option value="TRY" {% if customer and customer.currency == 'TRY' %}selected{% endif %}>TRY (₺)</option>
                        </select>
                    </div>
                </div>

                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Email</label>
                        <input type="email" name="email" class="form-control" value="{{ customer.email if customer else '' }}">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Phone</label>
                        <input type="text" name="phone" class="form-control" value="{{ customer.phone if customer else '' }}">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Deal Owner</label>
                        <input type="text" name="deal_owner" class="form-control" value="{{ customer.deal_owner if customer else '' }}">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Joined Date <span class="text-danger">*</span></label>
                        <input type="date" name="joined_date" id="joined_date" class="form-control" required value="{{ customer.joined_date|string if customer and customer.joined_date else '' }}">
                    </div>
                    <div class="col-12">
                        <label class="form-label">Tax Disclaimer</label>
                        <textarea name="tax_disclaimer" id="tax_disclaimer" class="form-control bg-light" rows="2" placeholder="Auto-filled for Forex/SEZ, or type manually...">{{ customer.tax_disclaimer if customer else '' }}</textarea>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Internal Notes</label>
                        <textarea name="notes" class="form-control" rows="3">{{ customer.notes if customer else '' }}</textarea>
                    </div>
                </div>

                <hr>
                <h5 class="text-primary">Documents</h5>

                {% if customer %}
                    <div class="input-group mb-3">
                        <input type="file" id="ajaxFileInput" class="form-control" accept=".pdf,.jpg,.png">
                        <button class="btn btn-outline-primary" type="button" onclick="uploadFile()">
                            <i class="fa fa-cloud-upload"></i> Upload & Save PDF
                        </button>
                    </div>
                    <small class="text-muted d-block mb-3">Uploads in this mode are saved immediately.</small>

                    <div class="list-group" id="fileList">
                        {% for doc in documents %}
                        <div class="list-group-item d-flex justify-content-between align-items-center" id="doc-{{ doc.id }}">
                            <div>
                                <i class="fa fa-file-pdf-o text-danger me-2"></i> 
                                <a href="{{ url_for('static', filename='uploads/' + doc.filename) }}" target="_blank" class="text-decoration-none">{{ doc.filename }}</a>
                                <span class="text-muted small ms-2">({{ doc.upload_date.strftime('%Y-%m-%d') }})</span>
                            </div>
                            <div class="btn-group btn-group-sm">
                                <a href="{{ url_for('static', filename='uploads/' + doc.filename) }}" target="_blank" class="btn btn-outline-secondary">View</a>
                                <a href="{{ url_for('static', filename='uploads/' + doc.filename) }}" download class="btn btn-outline-secondary">Download</a>
                                <a href="{{ url_for('delete_document', doc_id=doc.id) }}" class="btn btn-outline-danger" onclick="return confirm('Delete this file?');">Delete</a>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                {% else %}
                    <div class="alert alert-primary border-primary mb-3">
                        <h6 class="alert-heading fw-bold"><i class="fa fa-paperclip"></i> Upload Documents</h6>
                        <p class="mb-2 small">Select PDF/Image files here. They will be uploaded automatically when you click the "Save Customer Info" button below.</p>
                        <input type="file" name="documents" class="form-control" multiple accept=".pdf,.jpg,.png">
                    </div>
                {% endif %}

            </div>
        </div>

        <div class="d-flex justify-content-end mb-5">
            <a href="{{ url_for('list_customers') }}" class="btn btn-light border me-2">Cancel</a>
            <button type="submit" class="btn btn-primary px-4">Save Customer Info</button>
        </div>
    </form>
</div>

<script>
    const HOME_STATE = "Maharashtra"; 

    // --- CURRENCY MAP ---
    const currencyMap = {
        'India': 'INR', 'USA': 'USD', 'UK': 'GBP', 'UAE': 'AED', 'Singapore': 'SGD',
        'Australia': 'AUD', 'Canada': 'CAD', 'Japan': 'JPY', 'China': 'CNY',
        'Germany': 'EUR', 'France': 'EUR', 'Italy': 'EUR', 'Spain': 'EUR', 'Netherlands': 'EUR', 'Belgium': 'EUR',
        'Saudi Arabia': 'SAR', 'Qatar': 'QAR', 'Kuwait': 'KWD', 'Bahrain': 'BHD', 'Oman': 'OMR',
        'Thailand': 'THB', 'Malaysia': 'MYR', 'Indonesia': 'IDR', 'Vietnam': 'VND', 'Philippines': 'PHP',
        'Hong Kong': 'HKD', 'New Zealand': 'NZD', 'South Korea': 'KRW', 'Turkey': 'TRY'
    };

    function handleLocationChange() { autoUpdateTaxType(); toggleGSTFields(); }

    function updateCountryLogic() {
        const country = document.getElementById('country').value;
        const currencySelect = document.getElementById('currency');
        const stateInput = document.getElementById('state');
        const statusSelect = document.getElementById('gst_status');

        if (!country) return;

        // 1. Set Currency
        if (currencyMap[country]) {
            currencySelect.value = currencyMap[country];
        } else if (country !== 'India') {
            currencySelect.value = 'USD'; 
        } else {
            currencySelect.value = 'INR';
        }

        // 2. Set State & Status Logic
        if (country !== 'India') {
            statusSelect.value = 'No_Forex'; // Auto set to Forex
            stateInput.value = 'Outside India'; // Auto set State
        } else {
            statusSelect.value = 'Registered'; // Reset to Registered for India
            if (stateInput.value === 'Outside India') stateInput.value = '';
        }
        
        // 3. Trigger Field Updates
        toggleGSTFields();
    }

    function toggleGSTFields() {
        const status = document.getElementById('gst_status').value;
        const gstInput = document.getElementById('gst_number');
        const taxSelect = document.getElementById('gst_type');
        const disclaimer = document.getElementById('tax_disclaimer');

        if (status === 'Registered') {
            gstInput.disabled = false;
            taxSelect.disabled = false;
            autoUpdateTaxType(); 
            
            // Only clear disclaimer if it contains an auto-generated message.
            if(disclaimer.value.includes("No GST shall apply")) {
                disclaimer.value = "";
            }
        } else {
            gstInput.value = "";
            gstInput.disabled = true;
            taxSelect.value = ""; 
            taxSelect.disabled = true;
            
            // Auto-Fill Disclaimer
            if (status === 'No_Forex') {
                disclaimer.value = "No GST shall apply as the payment shall originate from outside of India.";
            } else if (status === 'No_SEZ') {
                disclaimer.value = "No GST shall apply as the company operates in SEZ area.";
            }
        }
    }

    function autoUpdateTaxType() {
        const state = document.getElementById('state').value;
        const country = document.getElementById('country').value;
        const taxSelect = document.getElementById('gst_type');
        const statusSelect = document.getElementById('gst_status');

        if (statusSelect.value === 'Registered') {
            if (country !== 'India') {
                taxSelect.value = "IGST"; 
            } else if (state === HOME_STATE) {
                taxSelect.value = "CGST_SGST";
            } else if (state && state !== "Outside India") {
                taxSelect.value = "IGST";
            } else {
                taxSelect.value = "";
            }
        }
    }
    
    // AJAX UPLOAD LOGIC
    function uploadFile() {
        const fileInput = document.getElementById('ajaxFileInput');
        const file = fileInput.files[0];
        if (!file) { alert("Please select a file first."); return; }
        
        {% if customer %}
        const customerId = {{ customer.id }};
        const formData = new FormData();
        formData.append('file', file);

        fetch(`/api/upload_document/${customerId}`, { method: 'POST', body: formData })
        .then(response => response.json())
        .then(data => {
            if (data.error) { alert(data.error); }
            else {
                const list = document.getElementById('fileList');
                const html = `
                <div class="list-group-item d-flex justify-content-between align-items-center" id="doc-${data.id}">
                    <div>
                        <i class="fa fa-file-pdf-o text-danger me-2"></i> 
                        <a href="${data.url}" target="_blank" class="text-decoration-none">${data.filename}</a>
                        <span class="text-muted small ms-2">(${data.date})</span>
                    </div>
                    <div class="btn-group btn-group-sm">
                        <a href="${data.url}" target="_blank" class="btn btn-outline-secondary">View</a>
                        <a href="${data.url}" download class="btn btn-outline-secondary">Download</a>
                        <a href="/delete_document/${data.id}" class="btn btn-outline-danger" onclick="return confirm('Delete?');">Delete</a>
                    </div>
                </div>`;
                list.insertAdjacentHTML('beforeend', html);
                fileInput.value = "";
            }
        });
        {% endif %}
    }

    window.onload = function() {
        // Initial setup on page load
        const status = document.getElementById('gst_status').value;
        const gstInput = document.getElementById('gst_number');
        const taxSelect = document.getElementById('gst_type');
        
        if (status !== 'Registered') {
            gstInput.disabled = true;
            taxSelect.disabled = true;
        }
        
        var dateInput = document.getElementById('joined_date');
        if (dateInput && !dateInput.value) dateInput.valueAsDate = new Date();
    };
</script>
{% endblock %}