{% extends "base.html" %}

{% block content %}
<div class="container" style="max-width: 1000px;">
    <form method="POST" id="contractForm">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3>{% if contract %}Edit Contract{% else %}Create New Contract{% endif %}</h3>
            <a href="{{ url_for('list_contracts') }}" class="btn btn-light border">Cancel</a>
        </div>

        <div class="row">
            <div class="col-md-4">
                <div class="card shadow-sm mb-3">
                    <div class="card-header bg-light fw-bold">Master Agreement</div>
                    <div class="card-body">
                        
                        {% if contract %}
                        <div class="mb-3">
                            <label class="form-label fw-bold text-danger">Contract Status</label>
                            <select name="status" class="form-select border-danger fw-bold">
                                <option value="Draft" {% if contract.status == 'Draft' or contract.status == 'not started' %}selected{% endif %}>Draft (Not Started)</option>
                                <option value="Active" {% if contract.status == 'Active' %}selected{% endif %}>Active</option>
                                <option value="On Hold" {% if contract.status == 'On Hold' %}selected{% endif %}>On Hold</option>
                                <option value="Completed" {% if contract.status == 'Completed' %}selected{% endif %}>Completed</option>
                                <option value="Terminated" {% if contract.status == 'Terminated' %}selected{% endif %}>Terminated</option>
                            </select>
                        </div>
                        {% endif %}

                        <div class="mb-3">
                            <label class="form-label">Customer</label>
                            <select name="customer_id" id="customer_select" class="form-select" onchange="fetchCustomerData()" required>
                                <option value="">-- Select Customer --</option>
                                {% for c in customers %}
                                <option value="{{ c.id }}" {% if contract and contract.customer_id == c.id %}selected{% endif %}>
                                    {{ c.company_name }}
                                </option>
                                {% endfor %}
                            </select>
                            
                            <div id="customer_info_card" class="card bg-light border-0 small mt-2 d-none">
                                <div class="card-body p-0 px-3 py-2">
                                    
                                    <div class="d-flex justify-content-between py-2 border-bottom border-white">
                                        <span class="text-muted">Currency:</span>
                                        <span class="fw-bold text-success" id="disp_currency">...</span>
                                    </div>

                                    <div class="d-flex justify-content-between py-2 border-bottom border-white">
                                        <span class="text-muted">GST Status:</span>
                                        <span class="fw-bold text-dark" id="disp_status">...</span>
                                    </div>

                                    <div class="d-flex justify-content-between py-2 border-bottom border-white">
                                        <span class="text-muted">GST Type:</span>
                                        <span class="fw-bold text-dark" id="disp_type">...</span>
                                    </div>

                                    <div class="d-flex justify-content-between py-2 border-bottom border-white">
                                        <span class="text-muted">GST No:</span>
                                        <span class="fw-bold text-dark" id="disp_gst">...</span>
                                    </div>

                                    <div class="d-flex justify-content-between py-2">
                                        <span class="text-muted">Location:</span>
                                        <span class="fw-bold text-dark" id="disp_location">...</span>
                                    </div>

                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Contract Title</label>
                            <input type="text" name="contract_name" class="form-control" value="{{ contract.contract_name if contract else '' }}" placeholder="e.g. Annual Maintenance 2026" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-muted small">PO / Agreement Ref (Optional)</label>
                            <input type="text" name="po_reference" class="form-control" 
                                   value="{{ contract.po_reference if contract and contract.po_reference else '' }}" 
                                   placeholder="e.g. PO-2026-998">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold small text-uppercase text-muted">Service Scope</label>
                            <div class="card bg-white border shadow-sm" style="max-height: 150px; overflow-y: auto;">
                                <div class="card-body p-2">
                                    <div class="d-flex flex-wrap gap-1">
                                        {% for service in services %}
                                        <input type="checkbox" class="btn-check" name="service_ids" id="svc_{{ service.id }}" value="{{ service.id }}" autocomplete="off"
                                            {% if current_service_ids and service.id in current_service_ids %}checked{% endif %}>
                                        <label class="btn btn-outline-secondary border-0 bg-light rounded-1 px-2 py-1" 
                                               for="svc_{{ service.id }}" style="font-size: 11px; font-weight: 600;">
                                            <i class="fa-solid fa-check me-1 d-none"></i>
                                            {{ service.service_name }}
                                        </label>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <style>
                            .btn-check:checked + .btn { background-color: #0d6efd !important; color: white !important; }
                            .btn-check:checked + .btn i { display: inline-block !important; }
                            .btn:hover { background-color: #e9ecef; }
                        </style>

                        <div class="mb-3">
                            <label class="form-label">Total Contract Value</label>
                            <div class="input-group">
                                <span class="input-group-text fw-bold text-success" id="currency_symbol"></span>
                                <input type="number" id="total_value" name="total_value" class="form-control fw-bold" step="0.01" value="{{ contract.total_value if contract else '' }}" oninput="updateBalance()" required>
                            </div>
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label class="form-label small">Start Date</label>
                                <input type="date" name="start_date" class="form-control" value="{{ contract.start_date if contract else '' }}" required>
                            </div>
                            <div class="col-6">
                                <label class="form-label small">End Date</label>
                                <input type="date" name="end_date" class="form-control" value="{{ contract.end_date if contract else '' }}" required>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-primary shadow-sm text-center">
                    <small class="text-uppercase fw-bold opacity-75">Unallocated Balance</small>
                    <h3 id="balance_display" class="mb-0 fw-bold mt-1">0.00</h3>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card shadow-sm" style="min-height: 500px;">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                        <span class="fw-bold">Payment Schedule (Slabs)</span>
                        <button type="button" class="btn btn-sm btn-primary" id="addSlabBtn" onclick="addSlab()">
                            <i class="fa-solid fa-plus"></i> Add Milestone
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped mb-0">
                                <thead class="table-light small text-muted text-uppercase">
                                    <tr>
                                        <th class="ps-3" width="5%">#</th>
                                        <th width="40%">Milestone Name</th>
                                        <th width="25%">Due Date</th>
                                        <th width="25%">Amount</th>
                                        <th width="5%"></th>
                                    </tr>
                                </thead>
                                <tbody id="slabContainer"></tbody>
                            </table>
                        </div>
                        <div id="limitMsg" class="text-center text-danger small py-2 d-none fw-bold">
                            <i class="fa-solid fa-triangle-exclamation me-1"></i> Maximum 12 slabs reached.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-4 text-end pb-5">
            <button type="button" onclick="validateAndSave()" class="btn btn-success px-5 py-2 fw-bold shadow-sm">Save Contract</button>
        </div>
    </form>
</div>

<script>
    let slabCount = 0;
    const MAX_SLABS = 12;

    window.onload = function() {
        fetchCustomerData(); // Load data on page load (edit mode)
        
        {% if contract and contract.slabs %}
            {% for slab in contract.slabs %}
                addSlab("{{ slab.slab_name }}", "{{ slab.due_date }}", "{{ slab.amount }}", "{{ slab.status }}");
            {% endfor %}
        {% else %}
            addSlab(); 
        {% endif %}
        
        updateBalance();
    };

    function validateAndSave() {
        const total = parseFloat(document.getElementById('total_value').value) || 0;
        const inputs = document.querySelectorAll('.slab-amount');
        let allocated = 0;
        
        inputs.forEach(input => { allocated += parseFloat(input.value) || 0; });
        const difference = Math.abs(total - allocated);

        if (difference > 0.01) {
            alert(`Error: Totals do not match.\n\nTarget: ${total}\nAllocated: ${allocated}\nDifference: ${difference.toFixed(2)}`);
            return;
        }

        const customer = document.getElementById('customer_select').value;
        const title = document.querySelector('input[name="contract_name"]').value;
        if(!customer || !title || total <= 0) {
            alert("Please fill in all required fields (Customer, Title, Total Value).");
            return;
        }

        document.getElementById('contractForm').submit();
    }

    function addSlab(name = '', date = '', amount = '', status = 'Pending') {
        if (slabCount >= MAX_SLABS) return;

        slabCount++;
        const container = document.getElementById('slabContainer');
        const row = document.createElement('tr');
        row.id = `row-${slabCount}`;
        
        row.innerHTML = `
            <td class="align-middle text-center text-muted fw-bold ps-3">${slabCount}</td>
            <td>
                <input type="text" name="slab_names[]" class="form-control form-control-sm border-0 bg-transparent" value="${name}" placeholder="e.g. Phase ${slabCount}" required>
                <input type="hidden" name="slab_statuses[]" value="${status}">
            </td>
            <td><input type="date" name="slab_dates[]" class="form-control form-control-sm" value="${date}" required></td>
            <td><input type="number" name="slab_amounts[]" class="form-control form-control-sm slab-amount" value="${amount}" step="0.01" oninput="updateBalance()" required></td>
            <td class="align-middle text-center">
                ${slabCount > 1 ? `<button type="button" class="btn btn-link text-danger p-0" onclick="removeSlab(${slabCount})"><i class="fa-solid fa-xmark"></i></button>` : ''}
            </td>
        `;
        
        container.appendChild(row);
        checkLimit();
    }

    function removeSlab(id) {
        document.getElementById(`row-${id}`).remove();
        slabCount--; 
        checkLimit();
        updateBalance();
    }

    function checkLimit() {
        const btn = document.getElementById('addSlabBtn');
        const msg = document.getElementById('limitMsg');
        btn.disabled = (slabCount >= MAX_SLABS);
        msg.classList.toggle('d-none', slabCount < MAX_SLABS);
    }

    function updateBalance() {
        const total = parseFloat(document.getElementById('total_value').value) || 0;
        const inputs = document.querySelectorAll('.slab-amount');
        let allocated = 0;
        inputs.forEach(input => { allocated += parseFloat(input.value) || 0; });

        const remaining = total - allocated;
        const display = document.getElementById('balance_display');
        const alertBox = display.parentElement;
        
        display.innerText = remaining.toFixed(2);
        
        alertBox.className = 'alert shadow-sm text-center ' + 
            (Math.abs(remaining) < 0.01 ? 'alert-success' : 'alert-danger');
        
        if (Math.abs(remaining) < 0.01) {
            display.innerText = "Balanced (0.00)";
        } else if (remaining < 0) {
            display.innerText = "Over Limit: " + remaining.toFixed(2);
        }
    }

    // ===============================================
    // FETCH CUSTOMER DATA FROM SERVER
    // ===============================================
    function fetchCustomerData() {
        const select = document.getElementById('customer_select');
        const card = document.getElementById('customer_info_card');
        const id = select.value;

        if (!id) {
            card.classList.add('d-none');
            return;
        }

        // Show card and loading state
        card.classList.remove('d-none');
        
        // Call Python API
        fetch(`/get_customer_details/${id}`)
            .then(response => response.json())
            .then(data => {
                // 1. Currency (Update Info Card + Total Value Input)
                const curr = data.currency || '';
                document.getElementById('disp_currency').innerText = curr;
                document.getElementById('currency_symbol').innerText = curr || '$'; // Fallback for input group

                // 2. GST Info
                document.getElementById('disp_gst').innerText = data.gst_number || 'N/A';
                document.getElementById('disp_type').innerText = data.gst_type || 'N/A';

                // Status
                let status = data.gst_status;
                if (status === 'Registered') status = 'Yes (Registered)';
                else if (status === 'No_Forex') status = 'No (Forex)';
                else if (status === 'No_SEZ') status = 'No (SEZ)';
                document.getElementById('disp_status').innerText = status || 'N/A';

                // 3. Location
                let locParts = [];
                if (data.city) locParts.push(data.city);
                if (data.state) locParts.push(data.state);
                
                let locString = locParts.join(', ');
                if (data.country) {
                    locString += (locString ? ` (${data.country})` : data.country);
                }
                document.getElementById('disp_location').innerText = locString || 'N/A';
            })
            .catch(error => {
                console.error('Error fetching customer:', error);
            });
    }
</script>
{% endblock %}