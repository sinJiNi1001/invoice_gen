<style>
/* --- SCREEN PREVIEW --- */
#previewModal { background: rgba(0,0,0,0.5); }
.modal-backdrop { display: none !important; }

.invoice-box { 
    width: 210mm; 
    min-height: 297mm;
    /* Reduced padding from 20mm to 10mm to let the table grow */
    padding: 10mm 12mm; 
    margin: auto;
    background: #fff;
    border: 2px solid #000 !important; 
    box-sizing: border-box;
    position: relative;
}

/* Add this to force the table to be as wide as possible */
.main-invoice-table {
    width: 100% !important;
    table-layout: fixed; /* Ensures columns stay the size you set */
    margin-top: 10px;
}

/* --- PRINT ALIGNMENT --- */
@page {
    size: A4;
    margin: 0;
}

@media print {
    body {
        margin: 0;
        padding: 0;
        background: #fff;
    }

    /* Hide everything except the modal content */
    body * { visibility: hidden; }
    #previewModal, #previewModal * { visibility: visible; }

    /* Force the modal to act as a full-page container */
    #previewModal {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        display: flex !important;
        justify-content: center;
        align-items: stretch;
        background: #fff !important;
    }

    .modal-dialog {
        margin: 0 !important;
        max-width: none !important;
        width: 100%;
    }

    .modal-content {
        border: none !important;
        box-shadow: none !important;
    }

    .invoice-box {
        margin: 0 !important;
        border: 2px solid #000 !important; /* Keeps border on paper */
        width: 210mm !important;
        height: 297mm !important;
        padding: 0 15mm !important; /* Internal spacing */
        visibility: visible !important;
        overflow: hidden; /* Ensures it stays on one page */
    }

    .no-print { display: none !important; }
}
</style>

<script>
function printInvoice() {
    // Standard delay to ensure browser focus
    setTimeout(() => {
        window.print();
    }, 250);
}

function generatePDF() {
    const original = document.getElementById('printableInvoice');
    const clone = original.cloneNode(true);

    // Keeping your exact style-injection logic
    clone.style.width = '210mm';
    clone.style.height = '297mm';
    clone.style.margin = '0';
    clone.style.border = '2px solid #000';
    clone.style.overflow = 'hidden';

    const wrapper = document.createElement('div');
    wrapper.style.background = '#fff';
    wrapper.appendChild(clone);

    // Corrected the ID to fetch from the preview span
    const invoiceNo = document.getElementById('p_invoice_no')?.innerText.trim() || 'Invoice';

    html2pdf().set({
        margin: 0,
        filename: 'Invoice_' + invoiceNo + '.pdf',
        image: { type: 'jpeg', quality: 1 },
        html2canvas: {
            scale: 2,
            useCORS: true,
            logging: false,
            letterRendering: true
        },
        jsPDF: {
            unit: 'mm',
            format: 'a4',
            orientation: 'portrait'
        }
    }).from(wrapper).save();
}
</script>


<div class="modal fade" id="previewModal" data-bs-backdrop="static" data-bs-keyboard="false"
     tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true" style="font-family: 'Calibri', sans-serif;">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">

            <div class="modal-header no-print">
                <h5 class="modal-title">Tax Invoice Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>

            <div class="modal-body p-4 bg-light">
                <div class="invoice-box bg-white mx-auto shadow-sm" id="printableInvoice">

                    <div class="row mb-2">
                        <div class="col-4">
                           <img src="{{ url_for('static', filename='logo.png') }}"
                        style="max-height: 50px; margin-left: -5px;" class="mb-2">
                        </div>
                        <div class="col-4 text-center mt-3">
                            <h5 class="fw-bold mb-1 mt-5">TAX INVOICE</h5>
                            <p class="text-warning small fw-bold mt-0"
                               style="font-size: 12pt;">ORIGINAL FOR RECIPIENT</p>
                        </div>
                        <div class="col-4 text-end">
                            <h5 class="fw-bold mb-0 text-nowrap"
                                style="font-size: 14pt;">Valency Networks Pvt. Ltd.</h5>
                            <div style="font-size: 10pt; line-height: 1.3;">
                                <span>GST No : 27AAKCV1496Q1ZC</span><br>
                                <span>PAN No : AAKCV1496Q</span><br>
                                <span>SAC : 998313</span><br>
                                <span>UDYAM-MH-26-0676862</span>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4 mt-5">
                        <div class="col-7">
                            <p class="mb-0 fw-bold">To</p>
                            <div id="p_customer_name" style="font-size: 12pt;">---</div>
                            <div id="p_customer_address" class="text-muted"
                                 style="display:inline-block;max-width:140px;
                                        word-wrap:break-word;white-space:normal;
                                        line-height:1.2;font-size:12pt;">
                                ---
                            </div>
                        </div>

                        <div class="col-5 text-end">
                            <div class="d-inline-flex text-start align-items-stretch p-2">
                                <div class="pe-2 text-end fw-bold" style="line-height:1.5;">
                                    <div>INVOICE NUMBER</div>
                                    <div>INVOICE DATE</div>
                                </div>
                                <div style="border-left:1px solid #000;width:1px;margin:0 10px;"></div>
                                <div class="ps-1" style="line-height:1.5;">
                                    <div id="p_invoice_no">---</div>
                                    <div id="p_invoice_date">---</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 mb-0">GST No. - <span id="p_customer_gst">---</span></div>

                    <table class="table table-bordered border-dark mb-0 main-invoice-table">
                        <thead class="text-center bg-light fw-bold">
                            <tr>
                                <th style="width:8%;">Count</th>
                                <th style="width:74%;">DESCRIPTION</th>
                                <th style="width:18%;">AMOUNT</th>
                            </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td class="text-center align-top pt-3">1</td>
                            <td class="align-top pt-3">
                                <div id="p_description" contenteditable="true"
                                     style="outline:none;line-height:1.6;min-height:400px;"></div>
                            </td>
                            <td id="p_amount_col"
                                class="text-end align-top pt-3 "
                                contenteditable="true"
                                style="outline:none;line-height:1.6;"></td>
                        </tr>
                        </tbody>

                        <tfoot class="border-top border-dark">
                        <tr>
                            <td colspan="2" class="p-0 border-dark">
                                <div class="d-flex h-100">
                                    <div id="p_notes" class="p-2 flex-grow-1"
                                         contenteditable="true"
                                         style="min-height:100px;font-size:12pt;"></div>
                                    <div style="width:1px;background:#000;"></div>
                                    <div class="pt-2 px-2 " style="width:120px;">
                                        <div class="mb-3">Subtotal</div>
                                        <div>Misc</div>
                                    </div>
                                </div>
                            </td>
                            <td class="p-0 border-dark">
                                <div class="d-flex flex-column h-100 text-end">
                                    <div class="p-2 border-bottom border-dark"
                                         id="p_subtotal_final"
                                         style="min-height:50px;">0.00</div>
                                    <div class="p-2"></div>
                                </div>
                            </td>
                        </tr>

                        <tr>
                            <td colspan="2"></td>
                                <td class="bg-light p-2" style="border:2px  min-height: 80px;">
                                <div class="d-flex flex-column justify-content-between h-100" style="min-height: 60px;">
                                    
                                    <div id="p_total_final" class="text-end " style="font-size: 14pt;">
                                        0.00
                                    </div>
                                    
                                    <div class="text-start" style="font-size: 8pt; font-weight: normal; color: #000;">
                                        Amount in <span id="p_curr">INR</span> unless specified
                                    </div>

                                </div>
                            </td>
                        </tr>
                        </tfoot>
                    </table>

                    <div class="row mt-4 align-items-end">
                        <div class="col-3 text-center">
                            <img src="{{ url_for('static', filename='stamp.png') }}"
                                 style="max-height:80px;">
                            <p class="fw-bold mb-0">Prashant Phatak</p>
                            <p class="m-0" style="font-size:9pt;">Founder, Director</p>
                        </div>
                        <div class="col-9">
                            <div class="ps-3 border-start border-dark"
                                 style="font-size:10pt;line-height:1.4;">
                                <p class="fw-bold mb-1">
                                    Cheques Payable : Valency Networks Pvt. Ltd.
                                </p>
                                <b>Bank name :</b> IDBI, Ganeshnagar (Erandawane), Pune, India 411004<br>
                                <b>Account number :</b> 0588102000014234<br>
                                <b>IFSC Code :</b> IBKL0000588 |
                                <b>Swift Code :</b> IBKLINBB007<br>
                                Address : 401 Ekdanta, Mehendale Garage Road,
                                Erandawane, Pune 411004, India<br>
                                Web : https://www.valencynetworks.com
                                &nbsp;&nbsp;Email : prashant@valencynetworks.com
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <div class="modal-footer no-print">
                <button type="button" class="btn btn-secondary"
                        data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success"
                        onclick="generatePDF()">Download PDF</button>
                <button type="button" class="btn btn-primary"
                        onclick="printInvoice()">Print Now</button>
            </div>

        </div>
    </div>
</div>

