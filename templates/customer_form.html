{% extends "base.html" %}

{% block content %}
<div class="container" style="max-width: 900px;">
    
    <form method="POST" action="{{ url_for('edit_customer', id=customer.id) if customer else url_for('create_customer') }}">
        
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white">
                <h4 class="mb-0">{{ 'Edit' if customer else 'Create' }} Customer Details</h4>
            </div>
            <div class="card-body">
                <div class="row g-3 mb-3">
                    <div class="col-md-12">
                        <label class="form-label">Company Name <span class="text-danger">*</span></label>
                        <input type="text" name="company_name" class="form-control" required 
                               value="{{ customer.company_name if customer else '' }}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Contact First Name</label>
                        <input type="text" name="first_name" class="form-control" placeholder="e.g. John"
                               value="{{ customer.first_name if customer else '' }}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Contact Last Name</label>
                        <input type="text" name="last_name" class="form-control" placeholder="e.g. Doe"
                               value="{{ customer.last_name if customer else '' }}">
                    </div>
                </div>

                <div class="row g-3 mb-3">
                    <div class="col-12">
                        <label class="form-label">Street Address</label>
                        <textarea name="address" class="form-control" rows="2">{{ customer.address if customer else '' }}</textarea>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">City</label>
                        <input type="text" name="city" class="form-control" 
                               value="{{ customer.city if customer else '' }}">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">State</label>
                        <select name="state" id="state" class="form-select" onchange="handleLocationChange()">
                            <option value="">Select State...</option>
                            <option value="Maharashtra" {% if customer and customer.state == 'Maharashtra' %}selected{% endif %}>Maharashtra</option>
                            <option value="Karnataka" {% if customer and customer.state == 'Karnataka' %}selected{% endif %}>Karnataka</option>
                            <option value="Delhi" {% if customer and customer.state == 'Delhi' %}selected{% endif %}>Delhi</option>
                            <option value="Tamil Nadu" {% if customer and customer.state == 'Tamil Nadu' %}selected{% endif %}>Tamil Nadu</option>
                            <option value="Gujarat" {% if customer and customer.state == 'Gujarat' %}selected{% endif %}>Gujarat</option>
                            <option value="West Bengal" {% if customer and customer.state == 'West Bengal' %}selected{% endif %}>West Bengal</option>
                            <option value="Outside India" {% if customer and customer.state == 'Outside India' %}selected{% endif %}>Outside India</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Country</label>
                        <select name="country" id="country" class="form-select" onchange="updateCurrency()">
                            <option value="India" {% if customer and customer.country == 'India' %}selected{% endif %}>India</option>
                            <option value="USA" {% if customer and customer.country == 'USA' %}selected{% endif %}>USA</option>
                            <option value="UK" {% if customer and customer.country == 'UK' %}selected{% endif %}>UK</option>
                            <option value="UAE" {% if customer and customer.country == 'UAE' %}selected{% endif %}>UAE</option>
                            <option value="Singapore" {% if customer and customer.country == 'Singapore' %}selected{% endif %}>Singapore</option>
                        </select>
                    </div>
                </div>

                <div class="row g-3 mb-3 p-3 bg-light rounded border">
                    <div class="col-md-3">
                        <label class="form-label">GST Status</label>
                        <select name="gst_status" id="gst_status" class="form-select" onchange="toggleGSTFields()">
                            <option value="Registered" {% if customer and customer.gst_status == 'Registered' %}selected{% endif %}>Yes (Registered)</option>
                            <option value="No_Forex" {% if customer and customer.gst_status == 'No_Forex' %}selected{% endif %}>No (Export/Forex)</option>
                            <option value="No_SEZ" {% if customer and customer.gst_status == 'No_SEZ' %}selected{% endif %}>No (SEZ)</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">GST Number</label>
                        <input type="text" name="gst_number" id="gst_number" class="form-control" 
                               value="{{ customer.gst_number if customer else '' }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Tax Type</label>
                        <select name="gst_type" id="gst_type" class="form-select">
                            <option value="">-- N/A --</option>
                            <option value="CGST_SGST" {% if customer and customer.gst_type == 'CGST_SGST' %}selected{% endif %}>CGST + SGST</option>
                            <option value="IGST" {% if customer and customer.gst_type == 'IGST' %}selected{% endif %}>IGST</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Currency</label>
                        <input type="text" name="currency" id="currency" class="form-control" 
                               value="{{ customer.currency if customer else 'INR' }}">
                    </div>
                </div>

                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Email</label>
                        <input type="email" name="email" class="form-control" value="{{ customer.email if customer else '' }}">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Phone</label>
                        <input type="text" name="phone" class="form-control" value="{{ customer.phone if customer else '' }}">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Deal Owner</label>
                        <input type="text" name="deal_owner" class="form-control" placeholder="Sales Rep"
                               value="{{ customer.deal_owner if customer else '' }}">
                    </div>
                    
                    <div class="col-md-4">
                        <label class="form-label">Joined Date <span class="text-danger">*</span></label>
                        <input type="date" name="joined_date" id="joined_date" class="form-control" required 
                               value="{{ customer.joined_date|string if customer and customer.joined_date else '' }}">
                    </div>
                    <div class="col-md-8">
                        </div>

                    <div class="col-12">
                        <label class="form-label">Internal Notes</label>
                        <textarea name="notes" class="form-control" rows="3" placeholder="Add notes here...">{{ customer.notes if customer else '' }}</textarea>
                    </div>
                </div>

            </div>
        </div>

        <div class="d-flex justify-content-end mb-5">
            <a href="{{ url_for('list_customers') }}" class="btn btn-light border me-2">Cancel</a>
            <button type="submit" class="btn btn-primary px-4">Save Customer</button>
        </div>
    </form>
</div>

<script>
    const HOME_STATE = "Maharashtra"; 

    function handleLocationChange() {
        autoUpdateTaxType();
        toggleGSTFields(); 
    }

    function autoUpdateTaxType() {
        const state = document.getElementById('state').value;
        const country = document.getElementById('country').value;
        const taxSelect = document.getElementById('gst_type');
        const statusSelect = document.getElementById('gst_status');

        if (statusSelect.value === 'Registered') {
            if (country !== 'India') {
                taxSelect.value = "IGST"; 
            } else if (state === HOME_STATE) {
                taxSelect.value = "CGST_SGST";
            } else if (state !== "") {
                taxSelect.value = "IGST";
            }
        }
    }

    function toggleGSTFields() {
        const status = document.getElementById('gst_status').value;
        const gstInput = document.getElementById('gst_number');
        const taxSelect = document.getElementById('gst_type');
        const country = document.getElementById('country').value;

        if (status === 'Registered') {
            gstInput.disabled = false;
            taxSelect.disabled = false;
            autoUpdateTaxType(); 
        } else {
            gstInput.value = "";
            gstInput.disabled = true;
            taxSelect.value = ""; 
            taxSelect.disabled = true;
        }

        if (country !== 'India' && status === 'Registered') {
            document.getElementById('gst_status').value = 'No_Forex';
            toggleGSTFields(); 
        }
    }

    const currencyMap = { 'India': 'INR', 'USA': 'USD', 'UK': 'GBP', 'UAE': 'AED', 'Singapore': 'SGD' };
    function updateCurrency() {
        const country = document.getElementById('country').value;
        const currencyInput = document.getElementById('currency');
        if (currencyMap[country]) currencyInput.value = currencyMap[country];
        if (country !== 'India') {
            document.getElementById('gst_status').value = 'No_Forex';
        } else {
            document.getElementById('gst_status').value = 'Registered';
        }
        toggleGSTFields();
    }
    
    window.onload = function() {
        toggleGSTFields();
        var dateInput = document.getElementById('joined_date');
        if (dateInput && !dateInput.value) {
            dateInput.valueAsDate = new Date();
        }
    };
</script>
{% endblock %}