{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Customer Management</h2>
    <a href="{{ url_for('create_customer') }}" class="btn btn-primary shadow-sm">
        <i class="fa-solid fa-plus me-2"></i>Add New Customer
    </a>
</div>

<div class="card p-3 mb-4 bg-light border-0 shadow-sm">
    <form method="get" action="{{ url_for('list_customers') }}" class="row g-2 align-items-center">
        
        <div class="col-md-3">
            <div class="input-group">
                <span class="input-group-text bg-white border-end-0"><i class="fa-solid fa-search text-muted"></i></span>
                <input type="text" name="search" class="form-control border-start-0" placeholder="Company Name..." value="{{ search_term }}">
            </div>
        </div>

        <div class="col-md-2">
            <select name="country" class="form-select" onchange="this.form.submit()">
                <option value="">All Countries</option>
                <option value="India" {% if country_filter == 'India' %}selected{% endif %}>India</option>
                <option value="USA" {% if country_filter == 'USA' %}selected{% endif %}>USA</option>
                <option value="UK" {% if country_filter == 'UK' %}selected{% endif %}>UK</option>
                <option value="UAE" {% if country_filter == 'UAE' %}selected{% endif %}>UAE</option>
                <option value="Singapore" {% if country_filter == 'Singapore' %}selected{% endif %}>Singapore</option>
            </select>
        </div>

        <div class="col-md-2">
            <select name="month" class="form-select" onchange="this.form.submit()">
                <option value="">Month</option>
                <option value="1" {% if filter_month == '1' %}selected{% endif %}>Jan</option>
                <option value="2" {% if filter_month == '2' %}selected{% endif %}>Feb</option>
                <option value="3" {% if filter_month == '3' %}selected{% endif %}>Mar</option>
                <option value="4" {% if filter_month == '4' %}selected{% endif %}>Apr</option>
                <option value="5" {% if filter_month == '5' %}selected{% endif %}>May</option>
                <option value="6" {% if filter_month == '6' %}selected{% endif %}>Jun</option>
                <option value="7" {% if filter_month == '7' %}selected{% endif %}>Jul</option>
                <option value="8" {% if filter_month == '8' %}selected{% endif %}>Aug</option>
                <option value="9" {% if filter_month == '9' %}selected{% endif %}>Sep</option>
                <option value="10" {% if filter_month == '10' %}selected{% endif %}>Oct</option>
                <option value="11" {% if filter_month == '11' %}selected{% endif %}>Nov</option>
                <option value="12" {% if filter_month == '12' %}selected{% endif %}>Dec</option>
            </select>
        </div>

        <div class="col-md-2">
            <select name="year" class="form-select" onchange="this.form.submit()">
                <option value="">Year</option>
                {% for y in range(2000, 2031) %}
                <option value="{{ y }}" {% if filter_year == y|string %}selected{% endif %}>{{ y }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-2">
            <select name="sort_by" class="form-select" onchange="this.form.submit()">
                <option value="newest" {% if sort_by == 'newest' %}selected{% endif %}>Newest Joined</option>
                <option value="oldest" {% if sort_by == 'oldest' %}selected{% endif %}>Oldest Joined</option>
                <option value="name_asc" {% if sort_by == 'name_asc' %}selected{% endif %}>Name (A-Z)</option>
            </select>
        </div>

        <div class="col-md-1">
            <a href="{{ url_for('list_customers') }}" class="btn btn-secondary w-100" title="Reset Filters"><i class="fa-solid fa-rotate-left"></i></a>
        </div>
    </form>
</div>

<div class="accordion" id="customerAccordion">
    {% for c in customers %}
    <div class="accordion-item shadow-sm mb-3 border-0 rounded overflow-hidden">
        <h2 class="accordion-header" id="heading{{ c.id }}">
            <div class="d-flex w-100 align-items-stretch">
                
                <button class="accordion-button collapsed bg-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ c.id }}">
                    <div class="d-flex align-items-center w-100">
                        <div class="rounded-circle bg-primary text-white d-flex justify-content-center align-items-center me-3 fw-bold" 
                             style="width: 40px; height: 40px; min-width: 40px;">
                            {{ c.company_name[:1] }}
                        </div>
                        <div class="me-auto">
                            <div class="fw-bold text-dark">{{ c.company_name }}</div>
                            <small class="text-muted"><i class="fa-solid fa-location-dot me-1"></i>{{ c.country }}</small>
                        </div>
                        <div class="d-none d-md-flex align-items-center me-3">
                            <span class="badge bg-light text-dark border me-2"><i class="fa-regular fa-calendar me-1"></i>{{ c.joined_date }}</span>
                            <span class="badge bg-secondary rounded-pill">{{ c.projects|length }} Projects</span>
                        </div>
                    </div>
                </button>

                <div class="bg-white border-start d-flex align-items-center px-3">
                    <a href="{{ url_for('edit_customer', id=c.id) }}" class="btn btn-sm btn-outline-primary text-nowrap">
                        <i class="fa-solid fa-pen me-1"></i>Edit
                    </a>
                </div>
            </div>
        </h2>
        
        <div id="collapse{{ c.id }}" class="accordion-collapse collapse" data-bs-parent="#customerAccordion">
            <div class="accordion-body bg-light border-top">
                <div class="row">
                    <div class="col-md-6 border-end">
                        <h6 class="text-uppercase text-muted small fw-bold mb-3">Contact & Internal</h6>
                        <ul class="list-unstyled small mb-0">
                            <li class="mb-2"><span class="text-muted w-25 d-inline-block">Deal Owner:</span> <strong>{{ c.deal_owner or '-' }}</strong></li>
                            <li class="mb-2"><span class="text-muted w-25 d-inline-block">Email:</span> {{ c.email or '-' }}</li>
                            <li class="mb-2"><span class="text-muted w-25 d-inline-block">Phone:</span> {{ c.phone or '-' }}</li>
                            <li class="mb-2"><span class="text-muted w-25 d-inline-block">PO/Ref:</span> 
                                <span class="badge bg-white text-dark border">{{ c.po_ref or '-' }}</span>
                            </li>
                        </ul>
                        {% if c.notes %}
                        <div class="mt-3 p-2 bg-warning bg-opacity-10 border border-warning rounded small text-dark">
                            <i class="fa-regular fa-sticky-note me-2 text-warning"></i>{{ c.notes }}
                        </div>
                        {% endif %}
                    </div>
                    <div class="col-md-6 ps-md-4 mt-3 mt-md-0">
                        <h6 class="text-uppercase text-muted small fw-bold mb-3">Billing Details</h6>
                        <ul class="list-unstyled small mb-3">
                            <li class="mb-1"><span class="text-muted me-2">GST/Tax ID:</span> {{ c.gst_number or 'N/A' }}</li>
                            <li class="mb-1"><span class="text-muted me-2">Currency:</span> {{ c.currency }}</li>
                        </ul>
                        <h6 class="text-uppercase text-muted small fw-bold mb-2">Projects</h6>
                        {% if c.projects %}
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered bg-white mb-0">
                                <thead class="table-light">
                                    <tr><th>Project</th><th>Status</th><th class="text-end">Value</th></tr>
                                </thead>
                                <tbody>
                                    {% for p in c.projects %}
                                    <tr>
                                        <td>{{ p.project_name }}</td>
                                        <td>
                                            {% if p.status == 'Active' %}<span class="badge bg-success">Active</span>
                                            {% elif p.status == 'Complete' %}<span class="badge bg-primary">Complete</span>
                                            {% elif p.status == 'Duped' %}<span class="badge bg-secondary">Duped</span>
                                            {% elif p.status == 'Cancel' %}<span class="badge bg-danger">Cancel</span>
                                            {% else %}<span class="badge bg-warning text-dark">On Hold</span>{% endif %}
                                        </td>
                                        <td class="text-end">{{ "{:,.2f}".format(p.total_value) }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                            <p class="text-muted small fst-italic">No projects added yet.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="text-center py-5"><h4 class="text-muted">No customers found.</h4></div>
    {% endfor %}
</div>
{% endblock %}