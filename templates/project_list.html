{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4" style="font-family: 'Calibri', sans-serif;">
    <h2>Project Management</h2>
    <a href="{{ url_for('create_project') }}" class="btn btn-primary shadow-sm">
        <i class="fa-solid fa-plus me-2"></i>Add New Project
    </a>
</div>
<div class="card p-3 mb-4 bg-light border-0 shadow-sm">
    <form method="GET" action="{{ url_for('list_projects') }}" id="filterForm" class="row g-2 align-items-center">
        
        <div class="col-md-5">
            <div class="input-group">
                <span class="input-group-text bg-white border-end-0"><i class="fa-solid fa-search text-muted"></i></span>
                <input type="text" name="search" id="searchInput" class="form-control border-start-0" 
                       placeholder="Search project or customer name..." value="{{ search_term }}" autocomplete="off">
            </div>
        </div>

        <div class="col-md-3">
            <select name="status" class="form-select" onchange="this.form.submit()">
                <option value="">All Statuses</option>
                <option value="Active" {% if status_filter == 'Active' %}selected{% endif %}>Active</option>
                <option value="Completed" {% if status_filter == 'Completed' %}selected{% endif %}>Completed</option>
                <option value="On Hold" {% if status_filter == 'On Hold' %}selected{% endif %}>On Hold</option>
                 <option value="Cancelled" {% if status_filter == 'Cancelled' %}selected{% endif %}>Cancelled</option>
            </select>
        </div>
        
        <div class="col-md-2 offset-md-2">
            <a href="{{ url_for('list_projects') }}" class="btn btn-secondary w-100">Reset</a>
        </div>
    </form>
</div>

<div class="accordion" id="projectAccordion">
    {% for p in projects %}
    <div class="accordion-item shadow-sm mb-3 border-0 rounded overflow-hidden">
        <h2 class="accordion-header" id="heading{{ p.id }}">
            <div class="d-flex w-100 align-items-stretch">
                
                <button class="accordion-button collapsed bg-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ p.id }}">
                    <div class="d-flex align-items-center w-100">
                        <div class="rounded-circle bg-success text-white d-flex justify-content-center align-items-center me-3 fw-bold" 
                             style="width: 40px; height: 40px; min-width: 40px;">
                            <i class="fa-solid fa-diagram-project"></i>
                        </div>
                        
                        <div class="me-auto">
                            <div class="fw-bold text-dark">{{ p.project_name }}</div>
                            <small class="text-muted">
                                <i class="fa-solid fa-building me-1"></i>{{ p.customer.company_name }}
                            </small>
                        </div>
                        
                        <div class="d-none d-md-flex align-items-center me-3">
                            <span class="badge bg-light text-dark border me-2">
                                {{ "{:,.2f}".format(p.total_value) }} {{ p.currency }}
                            </span>
                            <span class="badge {% if p.status == 'Active' %}bg-success{% elif p.status == 'Completed' %}bg-primary{% else %}bg-secondary{% endif %}">
                                {{ p.status }}
                            </span>
                        </div>
                    </div>
                </button>

                <div class="bg-white border-start d-flex align-items-center px-3">
                    <a href="{{ url_for('edit_project', id=p.id) }}" class="btn btn-sm btn-outline-primary text-nowrap">
                        <i class="fa-solid fa-pen me-1"></i>Edit
                    </a>
                </div>
            </div>
        </h2>
        
        <div id="collapse{{ p.id }}" class="accordion-collapse collapse" data-bs-parent="#projectAccordion">
            <div class="accordion-body bg-light border-top">
                <div class="row">
                    <div class="col-md-5 border-end">
                        <h6 class="text-uppercase text-muted small fw-bold mb-3" style="letter-spacing: 0.5px;">Project Info</h6>
                        
                        <div class="row mb-2 g-0">
                            <div class="col-4 text-muted small">PO Number</div>
                            <div class="col-8 small fw-bold text-dark">: {{ p.po_number or '-' }}</div>
                        </div>

                        <div class="row mb-2 g-0">
                            <div class="col-4 text-muted small">Start Date</div>
                            <div class="col-8 small text-dark">: {{ p.start_date or '-' }}</div>
                        </div>

                        <div class="row mb-2 g-0">
                            <div class="col-4 text-muted small">Payment</div>
                            <div class="col-8 small">
                                : <span class="badge bg-white text-primary border fw-semibold">{{ p.payment_type }}</span>
                            </div>
                        </div>

                        <div class="row g-0 mt-3">
                            <div class="col-12 text-muted small mb-2 text-uppercase fw-bold" style="font-size: 0.65rem;">Included Services</div>
                            <div class="col-12 d-flex flex-wrap gap-1">
                                {% if p.service_type %}
                                    {% for s in p.service_type.split(', ') %}
                                        <span class="badge bg-white text-dark border fw-normal shadow-sm">{{ s }}</span>
                                    {% endfor %}
                                {% else %}
                                    <span class="text-muted small">No services listed</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-7 ps-md-4">
                        <h6 class="text-uppercase text-muted small fw-bold mb-3">Payment Milestones</h6>
                        <div class="table-responsive bg-white rounded border">
                            <table class="table table-sm mb-0 small">
                                <thead class="table-light">
                                    <tr>
                                        <th>Slab Name</th>
                                        <th class="text-center">Percent</th>
                                        <th class="text-end">Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for slab in p.slabs %}
                                    <tr>
                                        <td>{{ slab.slab_name }}</td>
                                        <td class="text-center">{{ slab.percentage }}%</td>
                                        <td class="text-end fw-bold">{{ "{:,.2f}".format(slab.amount) }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                          </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="text-center py-5"><h4 class="text-muted">No projects found.</h4></div>
    {% endfor %}
</div>


<script>
    const searchInput = document.getElementById('searchInput');
    const filterForm = document.getElementById('filterForm');
    let typingTimer;
    const doneTypingInterval = 500; // Wait 500ms after user stops typing

    searchInput.addEventListener('input', function() {
        clearTimeout(typingTimer);
        typingTimer = setTimeout(function() {
            filterForm.submit();
        }, doneTypingInterval);
    });

    window.onload = function() {
        const val = searchInput.value;
        if(val) {
            searchInput.value = '';
            searchInput.focus();
            searchInput.value = val;
        }
    };
</script>
{% endblock %}