{% extends 'base.html' %}

{% block content %}
<div class="container-fluid">
    <div class="card shadow-sm border-0 mb-5 no-print">
        <div class="card-header bg-info text-black d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Edit Invoice: {{ invoice.invoice_number }}</h5>
            <small>Valency Networks - Billing Module</small>
        </div>
        <div class="card-body">
            <form method="POST" id="editInvoiceForm">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="fw-bold small">INVOICE NUMBER</label>
                        <div class="input-group">
                            <input type="text" name="invoice_number" id="invoice_number" class="form-control fw-bold text-primary bg-light" value="{{ invoice.invoice_number }}" readonly required oninput="syncPreview()">
                            <button class="btn btn-outline-secondary" type="button" onclick="toggleEdit()">ðŸ”“</button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="fw-bold small">INVOICE DATE</label>
                        <input type="date" name="invoice_date" id="invoice_date" class="form-control" value="{{ invoice.invoice_date }}" required oninput="syncPreview()">
                    </div>
                    <div class="col-md-4">
                        <label class="fw-bold small">CUSTOMER</label>
                        <select name="customer_id" id="customer_id" class="form-select" required onchange="syncPreview()">
                            {% for c in customers %}
                            <option value="{{c.id}}" data-currency="{{c.currency}}" data-name="{{c.company_name}}" data-address="{{c.address}}" data-taxid="{{c.tax_id}}" {% if invoice.customer_id == c.id %}selected{% endif %}>
                                {{c.company_name}}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="bg-light p-3 border rounded mb-4">
                    <label class="fw-bold small mb-2 text-primary">SERVICES & LINE ITEMS</label>
                    <table class="table table-sm align-middle">
                        <thead>
                            <tr class="small text-muted">
                                <th style="width: 40%;">Project</th>
                                <th style="width: 35%;">Service</th>
                                <th style="width: 20%;">Amount</th>
                                <th style="width: 5%;"></th>
                            </tr>
                        </thead>
                        <tbody id="items_body">
                            <tr class="service-row">
                                <td>
                                    <select name="project_ids[]" class="form-select form-select-sm proj-select" required onchange="syncPreview()">
                                        <option value="">Select Project...</option>
                                        {% for p in projects %}
                                        <option value="{{p.id}}" data-name="{{p.project_name}}">{{p.project_name}}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td>
                                    <select name="service_ids[]" class="form-select form-select-sm serv-select" onchange="syncPreview()">
                                        <option value="">Select Service...</option>
                                        {% for s in services %}
                                        <option value="{{s.id}}" data-name="{{s.service_name}}">{{s.service_name}}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td><input type="number" step="0.01" name="amounts[]" class="form-control form-control-sm item-amount" placeholder="0.00" oninput="syncPreview()"></td>
                                <td><button type="button" class="btn btn-sm btn-outline-danger border-0" onclick="removeRow(this)">âœ•</button></td>
                            </tr>
                        </tbody>
                    </table>
                    <button type="button" class="btn btn-sm btn-primary" onclick="addRow()">+ Add Another Service</button>
                </div>

                <div class="bg-white p-3 border rounded mb-4 shadow-sm">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <label class="fw-bold small text-primary">BILLING STRUCTURE (Slabs)</label>
                        <div class="btn-group btn-group-sm">
                            <input type="radio" class="btn-check" name="payment_structure" id="pay_full" value="full" {% if not invoice.slab_id %}checked{% endif %} onclick="toggleSlabs()">
                            <label class="btn btn-outline-primary" for="pay_full">Full (100%)</label>
                            <input type="radio" class="btn-check" name="payment_structure" id="pay_milestone" value="milestone" {% if invoice.slab_id %}checked{% endif %} onclick="toggleSlabs()">
                            <label class="btn btn-outline-primary" for="pay_milestone">Milestone-based</label>
                        </div>
                    </div>
                    <div id="slab_container" style="{% if invoice.slab_id %}display: block;{% else %}display: none;{% endif %}">
                        <table class="table table-sm border">
                            <tbody id="slab_body">
                                <tr class="slab-row">
                                    <td><input type="text" name="slab_names[]" class="form-control form-control-sm slab-name" placeholder="Slab Name" oninput="syncPreview()"></td>
                                    <td><input type="number" name="slab_percentages[]" class="form-control form-control-sm slab-perc" value="0" oninput="syncPreview()"></td>
                                    <td><input type="text" class="form-control form-control-sm slab-calculated bg-light" readonly value="0.00"></td>
                                    <td><button type="button" class="btn btn-sm text-danger" onclick="removeSlab(this)">âœ•</button></td>
                                </tr>
                            </tbody>
                        </table>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addSlab()">+ Add Slab</button>
                    </div>
                </div>

                <div class="bg-light p-3 border rounded mb-4 shadow-sm">
                    <label class="fw-bold small mb-2 text-success">COLLECTION DETAILS (Payment Tracking)</label>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="fw-bold extra-small text-muted">PAYMENT TYPE</label>
                            <select name="payment_type" class="form-select form-select-sm">
                                <option value="">Select Type</option>
                                <option value="Online Transfer / NEFT" {% if invoice.payment_type == 'Online Transfer / NEFT' %}selected{% endif %}>Online Transfer / NEFT</option>
                                <option value="Cheque" {% if invoice.payment_type == 'Cheque' %}selected{% endif %}>Cheque</option>
                                <option value="Cash" {% if invoice.payment_type == 'Cash' %}selected{% endif %}>Cash</option>
                                <option value="TDS Deducted" {% if invoice.payment_type == 'TDS Deducted' %}selected{% endif %}>TDS Deducted</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="fw-bold extra-small text-muted">AMOUNT RECEIVED</label>
                            <input type="number" step="0.01" name="amount_received" id="amount_received" class="form-control form-control-sm border-success fw-bold" 
                                   value="{{ invoice.amount_received or '0.00' }}" oninput="syncPreview()">
                        </div>
                        <div class="col-md-3">
                            <label class="fw-bold extra-small text-muted">RECEIVED DATE</label>
                            <input type="date" name="received_date" class="form-control form-control-sm border-success" value="{{ invoice.received_date }}">
                        </div>
                        <div class="col-md-3">
                            <label class="fw-bold extra-small text-muted">BALANCE DUE</label>
                            <input type="text" id="balance_due" class="form-control form-control-sm bg-white text-danger fw-bold" readonly value="0.00">
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-3">
                        <label class="fw-bold small">STATUS</label>
                        <select name="status" class="form-select">
                            {% for s in ['Raised','Unpaid','Paid','Overdue','Partially Paid'] %}
                            <option value="{{s}}" {% if invoice.status == s %}selected{% endif %}>{{s}}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="fw-bold small">TAX TYPE</label>
                        <select name="tax_type" id="tax_type" class="form-select" onchange="syncPreview()">
                            <option value="GST" {% if invoice.tax_type == 'GST' %}selected{% endif %}>GST (18%)</option>
                            <option value="IGST" {% if invoice.tax_type == 'IGST' %}selected{% endif %}>IGST (18%)</option>
                            <option value="NONE" {% if invoice.tax_type == 'NONE' %}selected{% endif %}>NONE (0%)</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="fw-bold small">TAX AMOUNT</label>
                        <input type="number" step="0.01" name="tax_amount" id="tax_amount" class="form-control bg-light" value="{{ invoice.tax_amount }}" readonly>
                    </div>
                    <div class="col-md-3">
                        <label class="fw-bold small">TOTAL (<span id="currency_label">INR</span>)</label>
                        <input type="number" step="0.01" name="total_amount" id="grand_total_input" class="form-control bg-light fw-bold text-primary" value="{{ invoice.total_amount }}" readonly>
                    </div>
                </div>

                <div class="d-flex justify-content-between">
                    <a href="{{ url_for('edit_list') }}" class="btn btn-outline-secondary px-4">Back</a>
                    <div>
                        <button type="button" class="btn btn-outline-primary px-4 me-2" onclick="window.print()">Print Updated Bill</button>
                        <button type="submit" id="saveInvoiceBtn" class="btn btn-success px-5 shadow">Update Invoice</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="invoice-box container mt-0 my-2 bg-white border" id="printableInvoice">
        <div class="row mb-2">
            <div class="col-4"><img src="{{ url_for('static', filename='logo.png') }}" style="max-height: 50px;"></div>
            <div class="col-4 text-center mt-3">
                <h5 class="fw-bold mb-1 mt-5">TAX INVOICE</h5>
                <p class="text-warning small fw-bold mt-0" style="font-size: 16px;">ORIGINAL FOR RECIPIENT</p>
            </div>
            <div class="col-4 text-end">
                <h5 class="fw-bold mb-0" style="font-size: 16px;">Valency Networks Pvt. Ltd.</h5>
                <div style="font-size: 11px;">GST No : 27AAKCV1496Q1ZC<br>PAN No : AAKCV1496Q</div>
            </div>
        </div>

        <div class="row mb-4 mt-5">
            <div class="col-7">
                <p class="mb-0 fw-bold small">To</p>
                <div id="p_customer_name" class="fw-bold h6 mb-1">---</div>
                <div id="p_customer_address" class="small text-muted" style="white-space: pre-wrap;">---</div>
                <div class="mt-4 small fw-bold">GST No. - <span id="p_customer_gst">---</span></div>
            </div>
            <div class="col-5 text-end small">
                <div class="d-inline-flex text-start">
                    <div class="pe-2 text-end">
                        <div>INVOICE NUMBER</div>
                        <div>INVOICE DATE</div>
                    </div>
                    <div style="border-left: 1px solid #000; width: 1px; margin: 0 10px;"></div>
                    <div class="ps-1">
                        <div id="p_invoice_no">---</div>
                        <div id="p_invoice_date">---</div>
                    </div>
                </div>
            </div>
        </div>

        <table class="table table-bordered border-dark mb-0">
            <thead class="text-center bg-light small fw-bold">
                <tr>
                    <th style="width: 10%;">Count</th>
                    <th style="width: 65%;">DESCRIPTION</th>
                    <th style="width: 25%;">AMOUNT</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="text-center align-top pt-3 border-bottom-0">1</td>
                    <td id="p_description" class="align-top pt-3 border-bottom-0" style="min-height: 450px; line-height: 1.6;"></td>
                    <td id="p_amount_col" class="text-end align-top pt-3 fw-bold border-bottom-0" style="line-height: 1.6;"></td>
                </tr>
            </tbody>
            <tfoot>
                <tr>
                    <td class="border-top-0"></td>
                    <td class="text-end fw-bold">Subtotal</td>
                    <td class="text-end fw-bold" id="p_subtotal_final">0.00</td>
                </tr>
                <tr>
                    <td class="border-top-0"></td>
                    <td class="text-end fw-bold">Total</td>
                    <td class="text-end fw-bold bg-light" id="p_total_final">0.00</td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

<style>
    .extra-small { font-size: 0.65rem; }
    .invoice-box { max-width: 850px; min-height: 800px; color: #000; font-family: sans-serif; background: white; padding: 40px; }
    .table-bordered.border-dark td, .table-bordered.border-dark th { border: 1px solid #000 !important; }
    @media print {
        .no-print, .navbar, .btn { display: none !important; }
        body * { visibility: hidden; }
        #printableInvoice, #printableInvoice * { visibility: visible; }
        #printableInvoice { position: absolute; left: 0; top: 0; width: 100%; border: none !important; }
    }
</style>

<script>
    function toggleEdit() {
        const input = document.getElementById('invoice_number');
        input.readOnly = !input.readOnly;
        input.classList.toggle('bg-light');
    }

    function addRow() {
        const body = document.getElementById('items_body');
        const firstRow = document.querySelector('.service-row');
        const newRow = firstRow.cloneNode(true);
        newRow.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
        newRow.querySelectorAll('input').forEach(i => i.value = "");
        body.appendChild(newRow);
        syncPreview();
    }

    function removeRow(btn) {
        if(document.querySelectorAll('.service-row').length > 1) btn.closest('tr').remove();
        syncPreview();
    }

    function toggleSlabs() {
        document.getElementById('slab_container').style.display = document.getElementById('pay_milestone').checked ? 'block' : 'none';
        syncPreview();
    }

    function addSlab() {
        const body = document.getElementById('slab_body');
        const firstRow = document.querySelector('.slab-row');
        const newRow = firstRow.cloneNode(true);
        newRow.querySelectorAll('input').forEach(i => i.value = "");
        body.appendChild(newRow);
        syncPreview();
    }

    function removeSlab(btn) {
        if(document.querySelectorAll('.slab-row').length > 1) btn.closest('tr').remove();
        syncPreview();
    }

    function syncPreview() {
        // 1. Basic Invoice Details
        document.getElementById('p_invoice_no').innerText = document.getElementById('invoice_number').value;
        document.getElementById('p_invoice_date').innerText = document.getElementById('invoice_date').value;

        // 2. Customer Details
        const cSel = document.getElementById('customer_id');
        const opt = cSel.options[cSel.selectedIndex];
        if (opt && opt.value) {
            document.getElementById('p_customer_name').innerText = opt.dataset.name || '---';
            document.getElementById('p_customer_address').innerText = opt.dataset.address || '---';
            document.getElementById('p_customer_gst').innerText = opt.dataset.taxid || 'N/A';
            document.getElementById('currency_label').innerText = opt.dataset.currency || 'INR';
        }

        let contractTotal = 0;
        let descLines = [];
        let amtLines = [];

        // 3. Process Line Items (Services)
        document.querySelectorAll('.service-row').forEach(row => {
            const pSel = row.querySelector('.proj-select');
            const sSel = row.querySelector('.serv-select');
            const amtInput = row.querySelector('.item-amount');
            
            const amtVal = parseFloat(amtInput.value) || 0;
            const pName = pSel.selectedIndex > 0 ? pSel.options[pSel.selectedIndex].dataset.name : "General Service";
            const sName = sSel.selectedIndex > 0 ? sSel.options[sSel.selectedIndex].dataset.name : "";

            contractTotal += amtVal;
            if (amtVal > 0 || pSel.selectedIndex > 0) {
                descLines.push(`<b>${pName}</b> ${sName ? '- ' + sName : ''}`);
                amtLines.push(amtVal.toLocaleString(undefined, {minimumFractionDigits: 2}));
            }
        });

        let taxableBase = contractTotal;

        // 4. Milestone / Slab Logic
        if (document.getElementById('pay_milestone').checked) {
            descLines = ["<b>Project Milestones:</b>"];
            amtLines = [""];
            let slabTotalPerc = 0;
            
            document.querySelectorAll('.slab-row').forEach(row => {
                const sNameInput = row.querySelector('.slab-name');
                const sPercInput = row.querySelector('.slab-perc');
                const sCalcInput = row.querySelector('.slab-calculated');

                const sName = sNameInput.value || "Milestone";
                const sPerc = parseFloat(sPercInput.value) || 0;
                const sAmt = (sPerc / 100) * contractTotal;
                
                sCalcInput.value = sAmt.toFixed(2);
                slabTotalPerc += sPerc;
                
                descLines.push(`- ${sName} (${sPerc}%)`);
                amtLines.push(sAmt.toLocaleString(undefined, {minimumFractionDigits: 2}));
            });
            taxableBase = (slabTotalPerc / 100) * contractTotal;
        }

        // 5. Tax Calculations
        const taxType = document.getElementById('tax_type').value;
        let taxAmt = 0;
        if (taxType !== 'NONE') {
            taxAmt = taxableBase * 0.18;
            if (taxType === 'GST') {
                descLines.push("CGST (9%)", "SGST (9%)");
                amtLines.push((taxAmt / 2).toLocaleString(undefined, {minimumFractionDigits: 2}), 
                             (taxAmt / 2).toLocaleString(undefined, {minimumFractionDigits: 2}));
            } else if (taxType === 'IGST') {
                descLines.push("IGST (18%)");
                amtLines.push(taxAmt.toLocaleString(undefined, {minimumFractionDigits: 2}));
            }
        }

        // 6. Final Totals and Collection Logic
        const grandTotal = taxableBase + taxAmt;
        const amountReceived = parseFloat(document.getElementById('amount_received').value) || 0;

        // Update Form Fields
        document.getElementById('tax_amount').value = taxAmt.toFixed(2);
        document.getElementById('grand_total_input').value = grandTotal.toFixed(2);
        document.getElementById('balance_due').value = (grandTotal - amountReceived).toFixed(2);

        // Update Printable Preview
        document.getElementById('p_description').innerHTML = descLines.join("<br>");
        document.getElementById('p_amount_col').innerHTML = amtLines.join("<br>");
        document.getElementById('p_subtotal_final').innerText = taxableBase.toLocaleString(undefined, {minimumFractionDigits: 2});
        document.getElementById('p_total_final').innerText = grandTotal.toLocaleString(undefined, {minimumFractionDigits: 2});
    }

    // Initialize on load
    window.onload = syncPreview;
</script>
{% endblock %}