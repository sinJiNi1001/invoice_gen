{% extends 'base.html' %}
{% block content %}
<div class="container mt-4" style="font-family: 'Calibri', sans-serif;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>Service Management</h2>
            <p class="text-muted small">Manage your billing service categories and types</p>
        </div>
        
        <div class="d-flex gap-2">
            <div class="input-group shadow-sm" style="width: 300px;">
                <span class="input-group-text bg-white border-end-0 text-muted small">
                    <i class="fas fa-search"></i>
                </span>
                <input type="text" id="serviceSearch" class="form-control border-start-0 ps-0 form-control-sm" 
                       placeholder="Search services..." onkeyup="filterServices()">
            </div>
            <button class="btn btn-primary shadow-sm" data-bs-toggle="modal" data-bs-target="#newServiceModal">
                <i class="fas fa-plus me-2"></i>Add New Service
            </button>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4" style="width: 80px;">ID</th>
                            <th>Service Name</th>
                            <th class="text-end pe-4" style="width: 200px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="serviceTableBody">
                        {% for s in services %}
                        <tr class="service-row">
                            <td class="ps-4 text-muted">#{{ loop.index }}</td>
                            <td><span class="fw-bold text-dark service-name">{{ s.service_name }}</span></td>
                            <td class="text-end pe-4">
                                <button class="btn btn-sm btn-outline-primary me-2" onclick="openEditModal('{{ s.id }}', '{{ s.service_name }}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="confirmDeleteStep1('{{ s.id }}', '{{ s.service_name }}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="3" class="text-center py-5 text-muted">No services found.</td></tr>
                        {% endfor %}
                        <tr id="noResults" style="display: none;">
                            <td colspan="3" class="text-center py-4 text-muted small">No matching services found.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="newServiceModal" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <form action="{{ url_for('manage_services') }}" method="POST" class="modal-content shadow">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold">Create New Service</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label text-muted small fw-bold">SERVICE NAME</label>
                    <input type="text" name="service_name" class="form-control form-control-lg" placeholder="e.g. VAPT / Audit" required>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-success px-4">Save Service</button>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="editServiceModal" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <form id="editServiceForm" method="POST" class="modal-content shadow">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold">Edit Service</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label text-muted small fw-bold">SERVICE NAME</label>
                    <input type="text" name="service_name" id="edit_service_name" class="form-control form-control-lg" required>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary px-4">Update Service</button>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="deleteStep1Modal" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-4">
                <i class="fas fa-exclamation-circle text-warning fa-3x mb-3"></i>
                <h4 class="fw-bold">Delete Service?</h4>
                <p class="text-muted">Are you sure you want to delete <strong id="delete_service_display" class="text-dark"></strong>?</p>
                <div class="d-flex justify-content-center gap-2 mt-4">
                    <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">No, Cancel</button>
                    <button type="button" class="btn btn-danger px-4" onclick="confirmDeleteStep2()">Yes, Delete it</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteStep2Modal" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content border-danger border-2">
            <form id="finalDeleteForm" method="POST">
                <div class="modal-body text-center p-4">
                    <h5 class="fw-bold text-danger">Double Check!</h5>
                    <p class="small text-muted">This action is irreversible.</p>
                    <button type="submit" class="btn btn-danger w-100 mb-2">I am absolutely sure</button>
                    <button type="button" class="btn btn-link btn-sm text-muted text-decoration-none" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let currentDeleteId = null;

// Search Logic
function filterServices() {
    let input = document.getElementById('serviceSearch').value.toLowerCase();
    let rows = document.getElementsByClassName('service-row');
    let noResults = document.getElementById('noResults');
    let matchFound = false;

    for (let i = 0; i < rows.length; i++) {
        let name = rows[i].querySelector('.service-name').innerText.toLowerCase();
        if (name.includes(input)) {
            rows[i].style.display = "";
            matchFound = true;
        } else {
            rows[i].style.display = "none";
        }
    }
    noResults.style.display = matchFound ? "none" : "";
}

function openEditModal(id, name) {
    const form = document.getElementById('editServiceForm');
    form.action = `/services/edit/${id}`; 
    document.getElementById('edit_service_name').value = name;
    var editModal = new bootstrap.Modal(document.getElementById('editServiceModal'));
    editModal.show();
}

function confirmDeleteStep1(id, name) {
    currentDeleteId = id;
    document.getElementById('delete_service_display').innerText = name;
    var modal1 = new bootstrap.Modal(document.getElementById('deleteStep1Modal'));
    modal1.show();
}

function confirmDeleteStep2() {
    bootstrap.Modal.getInstance(document.getElementById('deleteStep1Modal')).hide();
    const form = document.getElementById('finalDeleteForm');
    form.action = `/delete_service/${currentDeleteId}`;
    setTimeout(() => {
        var modal2 = new bootstrap.Modal(document.getElementById('deleteStep2Modal'));
        modal2.show();
    }, 400);
}
</script>
{% endblock %}